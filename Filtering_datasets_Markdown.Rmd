---
title: "Filtering_datasets"
author: "Solimary García & Micaela Santos"
date: "2025-06-02"
output:
  pdf_document: default
  html_document: default
---

## Descripción

El objetivo de este script es obtener el dataset final de GlobalFungi para ITS1 e ITS2.  
Los pasos incluyen:  

1. Filtrar muestras en hábitats naturales (no plantaciones) por `paper_id`.  
2. Agrupar muestras por proximidad geográfica (<90m).  
3. Crear un ID permanente por grupo y año del estudio.  
4. Exportar los datasets resultantes.

---

## Preparar ambiente de trabajo

```{r}
# Verificar archivos disponibles
list.files()  # Carpeta de trabajo debe ser la raíz de NEFINEO_MS.Rproj
```

---

## Abrir datasets

```{r}
# Cargar ITS1
its1 <- read.table("Data/globfungi_metadata_filtered_complemented_its1_soil.tsv", sep ="	")
length(unique(its1$PermanentID))  # 2815 muestras

# Artículos sin plantaciones para ITS1
its1.plant <- read.csv("Data/article_list_noplantation.its1.csv")

# Cargar ITS2
its2 <- read.table("Data/globfungi_metadata_filtered_complemented_its2_soil.tsv", sep ="	")
length(unique(its2$PermanentID))  # 2380 muestras

# Artículos sin plantaciones para ITS2
its2.plant <- read.csv("Data/article_list_noplantation.its2.csv")
```

---

## Filtrar artículos a mantener

```{r}
# ITS1
keep.its1 <- subset(its1.plant, To_keep == "yes", select = title)
v.keep.its1 <- ifelse(is.na(match(its1$paper_id, keep.its1$title)), "no", "yes")

# ITS2
keep.its2 <- subset(its2.plant, To_keep == "yes", select = title)
v.keep.its2 <- ifelse(is.na(match(its2$paper_id, keep.its2$title)), "no", "yes")
```

---

## Añadir columna de artículos seleccionados

```{r}
new.its1 <- cbind(its1[,1:5], paper_to_keep = v.keep.its1, its1[,6:171])
new.its2 <- cbind(its2[,1:5], paper_to_keep = v.keep.its2, its2[,6:171])
```

---

## Agrupar muestras por proximidad (90 metros)

```{r}
library(dplyr)
library(geosphere)

# Matrices de distancia geográfica
dist_matrix_its1 <- distm(new.its1[, c("longitude", "latitude")], fun = distHaversine)
dist_matrix_its2 <- distm(new.its2[, c("longitude", "latitude")], fun = distHaversine)

# Agrupamiento jerárquico
cluster_its1 <- hclust(as.dist(dist_matrix_its1), method = "complete")
cluster_its2 <- hclust(as.dist(dist_matrix_its2), method = "complete")

# Cortar dendrograma con umbral de 90m
groups_its1 <- cutree(cluster_its1, h = 90)
groups_its2 <- cutree(cluster_its2, h = 90)
```

---

## Añadir vector de grupos al dataset

```{r}
new.its1 <- cbind(new.its1[, 1:3], grouped_samples = groups_its1, new.its1[, 4:172])
new.its2 <- cbind(new.its2[, 1:3], grouped_samples = groups_its2, new.its2[, 4:172])
```

---

## Crear IDs permanentes para los grupos

```{r}
new.ID.its1 <- paste0("NEF_its1_", new.its1$grouped_samples, "_", new.its1$year)
new.ID.its2 <- paste0("NEF_its2_", new.its2$grouped_samples, "_", new.its2$year)

new.its1 <- cbind(new.ID = new.ID.its1, new.its1[, 1:173])
new.its2 <- cbind(new.ID = new.ID.its2, new.its2[, 1:173])
```

---

## Filtrar muestras y verificar agrupamientos

```{r}
final.its1 <- subset(new.its1, paper_to_keep == "yes")
final.its2 <- subset(new.its2, paper_to_keep == "yes")

length(unique(final.its1$grouped_samples))  # ITS1: 563
length(unique(final.its2$grouped_samples))  # ITS2: 729

# Verificar si hay grupos con muestras de más de un artículo
n.studies.its1 <- tapply(final.its1$paper_id, final.its1$new.ID, function(x) length(unique(x)))
n.studies.its1 <- n.studies.its1[n.studies.its1 > 1]

n.studies.its2 <- tapply(final.its2$paper_id, final.its2$new.ID, function(x) length(unique(x)))
n.studies.its2 <- n.studies.its2[n.studies.its2 > 1]
```

---

## Exportar datasets

```{r, eval=FALSE}
# Descomentar si quieres guardar los archivos
# write.csv(new.its1, file = "Data/new.its1.csv", row.names = FALSE)
# write.csv(new.its2, file = "Data/new.its2.csv", row.names = FALSE)
```
